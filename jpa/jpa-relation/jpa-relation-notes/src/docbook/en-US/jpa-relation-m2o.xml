<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
   "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd"  [ ]>

<chapter id="jpa-relation-m2o">
    <title>Many-to-One Relationships</title>
    
    <figure>
        <title>Many-to-One Uni-directional</title>
        <graphic scale="110" fileref="images/jpa-relation-many-to-one-uni.png"/>
    </figure>

    <variablelist spacing="compact">
        <varlistentry>
            <term><filename>Uni-directional</filename></term>
            <listitem><para>Only one side ("owner") knows of the relationship</para>
                <itemizedlist spacing="compact">
                    <listitem><para>Uses the @ManyToOne annotation</para></listitem>
                    <listitem><para>Defines mapping to database</para>
                        <itemizedlist spacing="compact">
                            <listitem><para>Uses either @JoinColumn or @JoinTable</para></listitem>
                        </itemizedlist>
                    </listitem>
                </itemizedlist>
            </listitem>
        </varlistentry>
        <varlistentry>
            <term><filename>Bi-directional</filename></term>
            <listitem><para>Same as <link linkend="jpa-relation-o2m-bi">One-to-Many Bi-directional</link></para></listitem>
        </varlistentry>
    </variablelist>
    
        
    <section id="jpa-relation-m2o-uni">
        <title>Many-to-One: Uni-directional</title>
        <itemizedlist spacing="compact">
            <listitem><para>Example uses composite key and derives primary key from foreign key</para></listitem>
            <listitem><para>Foreign key auto-generated</para></listitem>
        </itemizedlist>

        <figure>
            <title>Many-to-One Uni-directional Database Schema</title>
<programlisting language=""><![CDATA[
        create table ORMREL_MEDIA (
+-------->  MEDIA_ID bigint generated by default as identity,
|           title varchar(255),
|           primary key (MEDIA_ID)
|       )
|       create table ORMREL_MEDIACOPY (
|           COPY_NO integer not null,
`---------  MEDIACOPY_MID bigint not null,
            primary key (COPY_NO, MEDIACOPY_MID)
        )
        alter table ORMREL_MEDIACOPY 
            add constraint FKCDB47669F152B359 
            foreign key (MEDIACOPY_MID) 
            references ORMREL_MEDIA]]></programlisting>                        
        </figure>
            
        <figure>
            <title>Many-to-One Uni-directional Database Java Mapping</title>
<programlisting language="java"><![CDATA[
    @Entity @Table(name="ORMREL_MEDIACOPY2")
    @IdClass(MediaCopyPK2.class)
    @AttributeOverrides({
        @AttributeOverride(name="copyNo", column=@Column(name="COPY_NO"))
    })
    public class MediaCopy2 {
        @Id //mapped to COPY_NO by attribute override
        private int copyNo;    
        @Id 
        @ManyToOne 
        @JoinColumn(name="MEDIACOPY_MID")
+-----  private Media media;
|       
|       private MediaCopy2() {}
|       public MediaCopy2(Media media, int copyNo) {
|           this.media=media;
|           this.copyNo=copyNo;
|       }    
|   ...    
|   @Entity @Table(name="ORMREL_MEDIA")
|   public class Media  {
`---->  @Id @GeneratedValue @Column(name="MEDIA_ID")
        private long id;
]]></programlisting>                        
        </figure>
            
        <figure>
            <title>Many-to-One Uni-directional Database Usage</title>
<programlisting language="java"><![CDATA[ejava.examples.orm.rel.annotated.Media media = new Media();
media.setTitle("EJB31");

//add media to DB
assertTrue(media.getId() == 0);
em.persist(media);
log.info("created media:" + media);

//create some copies 
for(int i=0; i<5; i++) {
    ejava.examples.orm.rel.annotated.MediaCopy2 mc = 
        new MediaCopy2(media, i);
    assertNotNull(mc.getMedia());
    assertEquals(i, mc.getCopyNo());
    em.persist(mc);
    log.info("created copy:" + mc);
}]]></programlisting>                        
        </figure>
        
        <figure>
            <title>Many-to-One Uni-directional Database Output</title>
<programlisting language=""><![CDATA[Hibernate: 
    insert into ORMREL_MEDIA (MEDIA_ID, title) 
    values (null, ?)
-created media:Media@51942b40, id=1, title=EJB31, authors(0)={}
-created copy:MediaCopy2@3787f275, mediaId=1, copyNo=0, media=Media@51942b40, id=1, title=EJB31, authors(0)={}
...
-created copy:MediaCopy2@7a7fdbb0, mediaId=1, copyNo=4, media=Media@51942b40, id=1, title=EJB31, authors(0)={}
Hibernate: 
    insert into ORMREL_MEDIACOPY2 (COPY_NO, MEDIACOPY_MID) 
    values (?, ?)
...    
Hibernate: 
    insert into ORMREL_MEDIACOPY2 (COPY_NO, MEDIACOPY_MID) 
    values (?, ?)]]></programlisting>                        
        </figure>
    </section>
    
    <section id="jpa-relation-m2o-">
        <title>Summary</title>
        <itemizedlist spacing="compact">
            <listitem><para>Many-to-One models from child to parent</para></listitem>
            <listitem><para>More natural database construct</para></listitem>
        </itemizedlist>
        
    </section>
</chapter>
  
