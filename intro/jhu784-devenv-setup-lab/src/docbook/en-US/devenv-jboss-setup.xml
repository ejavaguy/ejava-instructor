<?xml version='1.0'?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">

    
<chapter id="devenv-jboss-setup">
    <title>JBoss (Wildfly) Setup</title>    
    <para>
        We will be using the JBoss/Wildfly Application Server this semester. This is a fully-compliant
        JavaEE 7 application server that includes a preview mode for JavaEE 8.
    </para>
    <note>
        <title>JBoss Application Server/Wildfly (AS) and JBoss Enterprise Application Platform (EAP)</title>
        <para>JBoss has a community version (formerly call JBoss AS - renamed Wildfly ~2012) and 
            commercial version (JBoss EAP) of 
            their JavaEE application server. Both are open source and built off the same code base. 
            In theory, changes propagate through the community version first in daily changes and 
            short iterations. In theory, commercial version is a roll-up of a stable version of the 
            community version with the ability to purchase support on that specific version. With  
            commercial version support - you can receive patches for a specific issue prior to 
            upgrading to the latest release. With the community version - you pretty much need to 
            keep up with the latest release to get any patches. Of course, with either version you
            are free to perform your own support and code changes, but you can only get this 
            commercially with the EAP release. There is a
            <ulink url="https://planet.jboss.org/post/jboss_eap_and_wildfly_a_symbiotic_relationship">newsgoup post</ulink>
            and <ulink url="http://www.slideshare.net/dandreadis/jboss-as7-reloaded">slide show</ulink>
            that provides a decent, short description of the two.
        </para>        
        <para>JBoss makes the EAP version available for *development* use from jboss.org but lags behind
            Wildfly (at wildfly.org) for obvious reasons. We will be using the
            open source/Wildfly version of the server.
            </para>
        <para>JBoss AS/Wildfly version numbers are ahead of JBoss EAP because not every community version
            becomes a commercial version. JBoss AS 6 was skipped entirely by EAP. 
        </para>
    </note>

    <section id="devenv-jboss-install">
        <title>Download and Install Wildfly 13.0.0.Final</title>
        <orderedlist spacing="compact">
            <listitem><para>Download Wildfly 13.0.0.Final
                <ulink url="http://www.wildfly.org/downloads/">http://www.wildfly.org/downloads/</ulink>.
                The 'Quickstarts' examples are also helpful but class notes, exercises, and guidance
                may have simplified, generalized, or alternative approaches to what is contained in the guides.</para>
            </listitem>
            <listitem>
                <para>
                    Install JBoss into a directory that does not have any spaces in its path.
                </para>
                <programlisting><![CDATA[$ unzip ~/Downloads/wildfly-13.0.0.Final.zip                
                
$ ls wildfly-13.0.0.Final/
appclient  bin  copyright.txt  docs  domain  jboss-modules.jar  LICENSE.txt  modules  README.txt  standalone  welcome-content
]]></programlisting>                        
            </listitem>
            <listitem>
                <para>
                    Test the installation by starting the default
                    configuration installation.
                </para>
                <programlisting><![CDATA[$ ./wildfly-13.0.0.Final/bin/standalone.sh
=========================================================================

  JBoss Bootstrap Environment

  JBOSS_HOME: /opt/wildfly-13.0.0.Final

  JAVA: java

  JAVA_OPTS:  -server -Xms64m -Xmx512m -XX:MetaspaceSize=96M -XX:MaxMetaspaceSize=256m -Djava.net.preferIPv4Stack=true -Djboss.modules.system.pkgs=org.jboss.byteman -Djava.awt.headless=true

=========================================================================

12:09:04,979 INFO  [org.jboss.modules] (main) JBoss Modules version 1.8.5.Final
12:10:29,008 INFO  [org.jboss.msc] (main) JBoss MSC version 1.4.2.Final
12:10:29,051 INFO  [org.jboss.threads] (main) JBoss Threads version 2.3.2.Final
12:10:29,319 INFO  [org.jboss.as] (MSC service thread 1-2) WFLYSRV0049: WildFly Full 13.0.0.Final (WildFly Core 5.0.0.Final) starting
...

12:10:56,481 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0060: Http management interface listening on http://127.0.0.1:9990/management
12:10:56,483 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0051: Admin console listening on http://127.0.0.1:9990
12:10:56,486 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0025: WildFly Full 13.0.0.Final (WildFly Core 5.0.0.Final) started in 46320ms - Started 290 of 511 services (308 services are lazy, passive or on-demand)
]]></programlisting>
                <note>
                    <para>There are .sh version of scripts for *nix platforms
                        and .bat forms of the scripts for Windows platforms.
                        Use the one that is appropriate for your environment. 
                    </para>
                </note>
            </listitem>
            <listitem><para>Verify you can access the server</para>
                <itemizedlist spacing="compact">
                    <listitem><para>Main Page:<ulink url="http://localhost:8080">http://localhost:8080</ulink></para></listitem>
                    <listitem><para>Admin Page:<ulink url="http://localhost:9990/console">http://localhost:9990/console</ulink>
                    This will fail until the admin account is added.</para></listitem>
                </itemizedlist>
            </listitem>
        </orderedlist>
    </section>
    
    <section id="devenv-jboss-configure">
        <title>Configure JBoss Server</title>
        <orderedlist spacing="compact">
            <listitem><para>Shutdown the server using Control-C</para></listitem>
            <listitem><para>Copy over the class example server files from what 
                you cloned and built from github earlier.</para>
<programlisting language=""><![CDATA[$ cd wildfly-13.0.0.Final

wildfly-13.0.0.Final]$ unzip -l .../ejava-student/servers/ejava-wildfly1300/target/ejava-wildfly1300-5.0.0-SNAPSHOT-server.zip 
Archive:  /home/jim/workspaces/ejava-class/ejava-student2/servers/ejava-wildfly1300/target/ejava-wildfly1300-5.0.0-SNAPSHOT-server.zip
  Length      Date    Time    Name
---------  ---------- -----   ----
        0  08-13-2018 12:21   domain/
        0  08-13-2018 12:21   domain/configuration/
        0  08-13-2018 12:21   standalone/
        0  08-13-2018 12:21   standalone/configuration/
     1774  08-13-2018 12:21   domain/configuration/application-roles.properties
     2402  08-13-2018 12:21   domain/configuration/application-users.properties
    37888  08-13-2018 12:21   standalone/configuration/standalone.xml
     1774  08-13-2018 12:21   standalone/configuration/application-roles.properties
     1190  08-13-2018 12:21   standalone/configuration/server.keystore
     2490  08-13-2018 12:21   standalone/configuration/application-users.properties
      575  08-13-2018 12:21   standalone/configuration/server.cer
---------                     -------
    48093                     11 files

wildfly-13.0.0.Final]$ unzip .../ejava-student/servers/ejava-wildfly1300/target/ejava-wildfly1300-5.0.0-SNAPSHOT-server.zip
Archive:  .../ejava-student2/servers/ejava-wildfly1300/target/ejava-wildfly1300-5.0.0-SNAPSHOT-server.zip
replace domain/configuration/application-roles.properties? [y]es, [n]o, [A]ll, [N]one, [r]ename: A
  inflating: domain/configuration/application-roles.properties  
...
]]></programlisting>
            </listitem>
            <listitem><para>Restart the server</para></listitem>
        </orderedlist>        
    </section>
    
    <section id="add-jboss-admin">
        <title>Add JBoss Admin Account</title>
        <orderedlist spacing="compact">
            <listitem><para>Use the batch script to add an admin user to 
                the system. Note the password must have at least one 
                digit and one non-alphanumeric character. If you
                run the application server on a remote machine or under
                a different account, please
                use the jboss.user and jboss.password supplied in 
                build/dependencies/pom.xml. JBoss/Wildfly will bypass
                user credentials when the client executes on the same 
                machine by the same user that started the server.
                </para>
<programlisting><![CDATA[ejava-student]$ egrep 'jboss.user|jboss.password' build/dependencies/pom.xml
        <jboss.user>admin</jboss.user>
        <jboss.password>password1!</jboss.password>
]]></programlisting>
                <programlisting><![CDATA[$ ./bin/add-user.sh 

What type of user do you wish to add? 
 a) Management User (mgmt-users.properties) 
 b) Application User (application-users.properties)
(a): 

Enter the details of the new user to add.
Using realm 'ManagementRealm' as discovered from the existing property files.
Username : admin
User 'admin' already exists and is disabled, would you like to... 
 a) Update the existing user password and roles 
 b) Enable the existing user 
 c) Type a new username
(a): a

What groups do you want this user to belong to? (Please enter a comma separated list, or leave blank for none)[  ]: 
Updated user 'admin' to file '/opt/wildfly-13.0.0.Final/standalone/configuration/mgmt-users.properties'
Updated user 'admin' to file '/opt/wildfly-13.0.0.Final/domain/configuration/mgmt-users.properties'
Updated user 'admin' with groups  to file '/opt/wildfly-13.0.0.Final/standalone/configuration/mgmt-groups.properties'
Updated user 'admin' with groups  to file '/opt/wildfly-13.0.0.Final/domain/configuration/mgmt-groups.properties'
Is this new user going to be used for one AS process to connect to another AS process? 
e.g. for a slave host controller connecting to the master or for a Remoting connection for server to server EJB calls.
yes/no? no
]]></programlisting>                        
            </listitem>
            <listitem>
                <para>Retry logging into the Admin Application
                    <ulink url="http://localhost:9990/console">http://localhost:9990/console</ulink>
                </para>
            </listitem>
        </orderedlist>
    </section>
    
    <section id="enable-jboss-debug">
        <title>Enable JBoss Remote Debugging</title>
        <para>Wildfly comes already prepared for remote debugging using a command line option.
        Therefore there is no longer anything detailed to do with step (nice!)</para>
        <orderedlist spacing="compact">
            <listitem><para>Restart the Wildfly server in debug mode. The default port
            is 8787, but can be easily customized with an extra command line argument.
            </para>
                <programlisting><![CDATA[## from bin/standalone.sh
# Use --debug to activate debug mode with an optional argument to specify the port.
# Usage : standalone.sh --debug
#         standalone.sh --debug 9797
]]></programlisting>                        
            </listitem>
            <listitem><para>Restart the server and notice the additional listen
                output. Use control-C to stop the server.</para>
                <programlisting><![CDATA[$ ./bin/standalone.sh --debug
=========================================================================
...
=========================================================================

Listening for transport dt_socket at address: 8787
<control-C>

$ ./bin/standalone.sh --debug 8000
=========================================================================
...
=========================================================================

Listening for transport dt_socket at address: 8000
]]></programlisting>                        
            </listitem>
        </orderedlist>
    </section>



    <section id="enable-jboss-networking">
        <title>(Optional) Using Alternate Networks</title>
        <para>
            If you already have a process listening on localhost:8080 or any of 
            the other JBoss ports on 127.0.0.1, you can switch addresses
            by editing the <code>interfaces</code> section of 
            standandalone.xml. You can also do this at runtime by adding 
            <code>-Djboss.bind.address.management=...</code>
            and/or 
            <code>-Djboss.bind.address=...</code> on the command line. 
        </para>
        <note>
            <para>Note that I said "If..." above. You only need to modify the network 
                information if you are running into a conflict on your development 
                platform. Change is not hard, but keeping the default is the simplest
                way to go.
            </para>
        </note>
      <orderedlist spacing="compact">            
            <listitem>
                <programlisting language="xml"><![CDATA[
    <interfaces>
        <interface name="management">
            <loopback-address value="${jboss.bind.address.management:127.0.0.2}"/>
        </interface>
        <interface name="public">
            <loopback-address value="${jboss.bind.address:127.0.0.2}"/>
        </interface>
        <interface name="unsecure">
            <inet-address value="${jboss.bind.address.unsecure:127.0.0.2}"/>
        </interface>
    </interfaces>
]]></programlisting>                        
            </listitem> 
            <listitem>
                <para>
                    Provide a specification to maven where your JBoss server
                    has been installed in the <code>.m2/settings.xml</code>
                    file using the <code>jboss.home</code> property. *If* you 
                    have changed the address - you can specify that using
                    the <code>jboss.host</code> property. 
                </para>
                <programlisting language="xml"><![CDATA[
        <profile>
            <id>wildfly13</id>
            <properties>
                <jboss.host>127.0.0.2</jboss.host>
                <jboss.home>/opt/wildfly-13.0.0.Final</jboss.home>
            </properties>
        </profile>
    </profiles>
        ...
    <activeProfiles>
        <activeProfile>wildfly13</activeProfile>
        <activeProfile>h2db</activeProfile>
    </activeProfiles>
</settings>
]]></programlisting>                        
            </listitem>
        </orderedlist>
    </section>
</chapter>
