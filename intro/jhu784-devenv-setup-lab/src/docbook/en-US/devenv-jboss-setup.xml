<?xml version='1.0'?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">

    
<chapter id="devenv-jboss-setup">
    <title>JBoss Setup</title>    
    <para>
        We will be using the JBoss/Wildfly Application Server this semester. This is a fully-compliant
        JavaEE 7 application server.
    </para>
    <note>
        <title>JBoss Application Server/Wildfly (AS) and JBoss Enterprise Application Platform (EAP)</title>
        <para>JBoss has a community version (formerly call JBoss AS - recently renamed Wildfly) and 
            commercial version (JBoss EAP) of 
            their JavaEE application server. Both are open source and built off the same code base. 
            In theory, changes propagate through the community version first in daily changes and 
            short iterations. In theory, commercial version is a roll-up of a stable version of the 
            community version with the ability to purchase support on that specific version. With  
            commercial version support - you can receive patches for a specific issue prior to 
            upgrading to the latest release. With the community version - you pretty much need to 
            keep up with the latest release to get any patches. Of course, with either version you
            are free to perform your own support and code changes, but you can only get this 
            commercially with the EAP release. There is a
            <ulink url="https://planet.jboss.org/post/jboss_eap_and_wildfly_a_symbiotic_relationship">newsgoup post</ulink>
            and <ulink url="http://www.slideshare.net/dandreadis/jboss-as7-reloaded">slide show</ulink>
            that provides a decent, short description of the two.
        </para>        
        <para>JBoss makes the EAP version available for *development* use from jboss.org but you will notice
            it has not yet caught up with Wildfly 8.x (at wildfly.org) just yet. We will be using the
            open source/Wildfly version of the server - which is fully JavaEE 7-compliant.
            </para>
        <para>JBoss AS/Wildfly version numbers are ahead of JBoss EAP because not every community version
            becomes a commercial version. JBoss AS 6 was skipped entirely by EAP. 
        </para>
    </note>

    <section id="devenv-jboss-install">
        <title>Download and Install Wildfly 8.1.0.Final</title>
        <orderedlist spacing="compact">
            <listitem><para>Download Wildfly 8.1.0.Final
                <ulink url="http://www.wildfly.org/downloads/">http://www.wildfly.org/downloads/</ulink>.
                The 'Quickstarts' examples are also helpful but class notes, exercises, and guidance
                may have simplified, generalized, or alternative approaches to what is contained in the guides.</para>
            </listitem>
            <listitem>
                <para>
                    Install JBoss into a directory that does not have any spaces in its path.
                </para>
                <programlisting><![CDATA[
$ unzip ~/Downloads/wildfly-8.1.0.Final.zip                
                
$ ls wildfly-8.1.0.Final/                                                                                                                                        
appclient  bin  copyright.txt  docs  domain  jboss-modules.jar  LICENSE.txt  modules  README.txt  standalone  welcome-content
]]></programlisting>                        
            </listitem>
            <listitem>
                <para>
                    Test the installation by starting the default
                    configuration installation.
                </para>
                <programlisting><![CDATA[
$ ./wildfly-8.1.0.Final/bin/standalone.sh 
=========================================================================

  JBoss Bootstrap Environment

  JBOSS_HOME: /opt/wildfly-8.1.0.Final

  JAVA: /usr/bin/java

  JAVA_OPTS:  -server -Xms64m -Xmx512m -XX:MaxPermSize=256m -Djava.net.preferIPv4Stack=true -Djboss.modules.system.pkgs=org.jboss.byteman -Djava.awt.headless=true

=========================================================================

21:35:00,228 INFO  [org.jboss.modules] (main) JBoss Modules version 1.3.3.Final
21:35:00,790 INFO  [org.jboss.msc] (main) JBoss MSC version 1.2.2.Final
21:35:00,947 INFO  [org.jboss.as] (MSC service thread 1-2) JBAS015899: WildFly 8.1.0.Final "Kenny" starting

...

21:35:08,852 INFO  [org.jboss.as.server.deployment.scanner] (MSC service thread 1-1) JBAS015012: Started FileSystemDeploymentService for directory /opt/wildfly-8.1.0.Final/standalone/deployments
21:35:09,317 INFO  [org.jboss.ws.common.management] (MSC service thread 1-3) JBWS022052: Starting JBoss Web Services - Stack CXF Server 4.2.4.Final
21:35:28,904 INFO  [org.jboss.as.connector.subsystems.datasources] (MSC service thread 1-1) JBAS010400: Bound data source [java:jboss/datasources/ExampleDS]
21:35:28,991 INFO  [org.jboss.as] (Controller Boot Thread) JBAS015961: Http management interface listening on http://127.0.0.1:9990/management
21:35:28,992 INFO  [org.jboss.as] (Controller Boot Thread) JBAS015951: Admin console listening on http://127.0.0.1:9990
21:35:28,993 INFO  [org.jboss.as] (Controller Boot Thread) JBAS015874: WildFly 8.1.0.Final "Kenny" started in 29699ms - Started 184 of 233 services (81 services are lazy, passive or on-demand)
]]></programlisting>                        
                <note>
                    <para>There are .sh version of scripts for *nix platforms
                        and .bat forms of the scripts for Windows platforms.
                        Use the one that is appropriate for your environment. 
                    </para>
                </note>
            </listitem>
            <listitem><para>Verify you can access the server</para>
                <itemizedlist spacing="compact">
                    <listitem><para>Main Page:<ulink url="http://localhost:8080">http://localhost:8080</ulink></para></listitem>
                    <listitem><para>Admin Page:<ulink url="http://localhost:9990/console">http://localhost:9990/console</ulink>
                    This will fail until the admin account is added.</para></listitem>
                </itemizedlist>
            </listitem>
        </orderedlist>
    </section>
    
    <section id="devenv-jboss-configure">
        <title>Configure JBoss Server</title>
        <orderedlist spacing="compact">
            <listitem><para>Shutdown the server using Control-C</para></listitem>
            <listitem><para>Copy over the class example server files from what 
                you cloned and built from github earlier.</para>
<programlisting language=""><![CDATA[
$ cd wildfly-8.1.0.Final
wildfly-8.1.0.Final]$ unzip -l .../ejava-student/servers/ejava-wildfly810/target/ejava-wildfly810-4.0.0-SNAPSHOT-server.zip 
Archive:  .../ejava-student/servers/ejava-wildfly810/target/ejava-wildfly810-4.0.0-SNAPSHOT-server.zip
  Length      Date    Time    Name
---------  ---------- -----   ----
        0  09-02-2014 21:48   standalone/
        0  09-02-2014 21:48   standalone/configuration/
        0  09-02-2014 21:48   domain/
        0  09-02-2014 21:48   domain/configuration/
      575  09-02-2014 21:48   standalone/configuration/server.cer
     1747  09-02-2014 21:48   standalone/configuration/application-roles.properties
     1190  09-02-2014 21:48   standalone/configuration/server.keystore
    31118  09-02-2014 21:48   standalone/configuration/standalone.xml
     2490  09-02-2014 21:48   standalone/configuration/application-users.properties
     1747  09-02-2014 21:48   domain/configuration/application-roles.properties
     2402  09-02-2014 21:48   domain/configuration/application-users.properties
---------                     -------
    41269                     11 files
$ unzip /home/jcstaff/workspaces/ejava-class/ejava-student/servers/ejava-wildfly810/target/ejava-wildfly810-4.0.0-SNAPSHOT-server.zip 
Archive:  /home/jcstaff/workspaces/ejava-class/ejava-student/servers/ejava-wildfly810/target/ejava-wildfly810-4.0.0-SNAPSHOT-server.zip
  inflating: standalone/configuration/server.cer  
replace standalone/configuration/application-roles.properties? [y]es, [n]o, [A]ll, [N]one, [r]ename: y
  inflating: standalone/configuration/application-roles.properties  
...
]]></programlisting>
            </listitem>
            <listitem><para>Restart the server</para></listitem>
        </orderedlist>        
    </section>
    
    <section id="add-jboss-admin">
        <title>Add JBoss Admin Account</title>
        <orderedlist spacing="compact">
            <listitem><para>Use the batch script to add an admin user to 
                the system. Note the password must have at least one 
                digit and one non-alphanumeric character. If you
                run the application server on a remote machine or under
                a different account, please
                use the jboss.user and jboss.password supplied in 
                build/dependencies/pom.xml. JBoss/Wildfly will bypass
                user credentials when the client executes on the same 
                machine by the same user that started the server.
                </para>
<programlisting>xml<![CDATA[$ grep jboss.user build/dependencies/pom.xml 
        <jboss.user>admin</jboss.user>
$ grep jboss.password build/dependencies/pom.xml 
        <jboss.password>password1!</jboss.password>]]></programlisting>
                <programlisting><![CDATA[
$ ./bin/add-user.sh 

What type of user do you wish to add? 
 a) Management User (mgmt-users.properties) 
 b) Application User (application-users.properties)
(a): 

Enter the details of the new user to add.
Using realm 'ManagementRealm' as discovered from the existing property files.
Username : admin
The username 'admin' is easy to guess
Are you sure you want to add user 'admin' yes/no? yes
Password recommendations are listed below. To modify these restrictions edit the add-user.properties configuration file.
 - The password should not be one of the following restricted values {root, admin, administrator}
 - The password should contain at least 8 characters, 1 alphabetic character(s), 1 digit(s), 1 non-alphanumeric symbol(s)
 - The password should be different from the username
Password : 
Re-enter Password : 
What groups do you want this user to belong to? (Please enter a comma separated list, or leave blank for none)[  ]: 
About to add user 'admin' for realm 'ManagementRealm'
Is this correct yes/no? yes
Added user 'admin' to file '/opt/wildfly-8.1.0.Final/standalone/configuration/mgmt-users.properties'
Added user 'admin' to file '/opt/wildfly-8.1.0.Final/domain/configuration/mgmt-users.properties'
Added user 'admin' with groups  to file '/opt/wildfly-8.1.0.Final/standalone/configuration/mgmt-groups.properties'
Added user 'admin' with groups  to file '/opt/wildfly-8.1.0.Final/domain/configuration/mgmt-groups.properties'
Is this new user going to be used for one AS process to connect to another AS process? 
e.g. for a slave host controller connecting to the master or for a Remoting connection for server to server EJB calls.
yes/no? no
]]></programlisting>                        
            </listitem>
            <listitem>
                <para>Retry logging into the Admin Application
                    <ulink url="http://localhost:9990/console">http://localhost:9990/console</ulink>
                </para>
            </listitem>
        </orderedlist>
    </section>
    
    <section id="enable-jboss-debug">
        <title>Enable JBoss Remote Debugging</title>
        <para>Prepare your server for remote debugging for later.</para>
        <orderedlist spacing="compact">
            <listitem><para>Uncomment the following line in either 
            bin/standalone.conf (Linux) or bin/standalone.conf.bat (Windows)</para>
                <programlisting><![CDATA[
# Sample JPDA settings for remote socket debugging
JAVA_OPTS="$JAVA_OPTS -Xrunjdwp:transport=dt_socket,address=8787,server=y,suspend=n"
]]></programlisting>                        
            </listitem>
            <listitem><para>Restart the server and notice the additional listen
                output. Use control-C to stop the server.</para>
                <programlisting><![CDATA[
$ ./bin/standalone.sh 
=========================================================================
...

=========================================================================

Listening for transport dt_socket at address: 8787
]]></programlisting>                        
            </listitem>
            
            <listitem>
                <para>
                    If you already have a process listening on 8080 or any of 
                    the other JBoss ports on 127.0.0.1, you can switch addresses
                    by editing the <code>interfaces</code> section of 
                    standandalone.xml. You can also do this at runtime by adding 
                    <code>-Djboss.bind.address.management=...</code>
                    and/or 
                    <code>-Djboss.bind.address=...</code> on the command line. 
                </para>
                <programlisting language="xml"><![CDATA[
    <interfaces>
        <interface name="management">
            <loopback-address value="${jboss.bind.address.management:127.0.0.5}"/>
        </interface>
        <interface name="public">
            <loopback-address value="${jboss.bind.address:127.0.0.5}"/>
        </interface>
        <interface name="unsecure">
            <inet-address value="${jboss.bind.address.unsecure:127.0.0.5}"/>
        </interface>
    </interfaces>
]]></programlisting>                        
            </listitem>
        </orderedlist>
        <note>
            <para>Note that I said "If..." above. You only need to modify the network 
                information if you are running into a conflict on your development 
                platform. Change is not hard, but keeping the default is the simplest
                way to go.
            </para>
        </note>
    </section>
    
    <section id="devenv-jboss-maven">
        <title>Define JBoss Maven Properties in settings.xml</title>
        <orderedlist spacing="compact">
            <listitem>
                <para>
                    Provide a specification to maven where your JBoss server
                    has been installed in the <code>.m2/settings.xml</code>
                    file using the <code>jboss.home</code> property. *If* you 
                    have changed the address - you can specify that using
                    the <code>jboss.host</code> property. 
                </para>
                <programlisting language="xml"><![CDATA[
        <profile>
            <id>jboss8</id>
            <properties>
                <jboss.host>127.0.0.1</jboss.host>
                <jboss.home>/opt/wildfly-8.1.0.Final</jboss.home>
            </properties>
        </profile>
    </profiles>
        ...
    <activeProfiles>
        <activeProfile>jboss8</activeProfile>
        <activeProfile>h2db</activeProfile>
    </activeProfiles>
</settings>
]]></programlisting>                        
            </listitem>
        </orderedlist>
    </section>
</chapter>
